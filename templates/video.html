<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Renderer</title>
  <style>
    :root{
      --yellow:#f2c94c; --cyan:#56ccf2; --red:#ff5b5b; --panel:#0e1116cc; --text:#e6edf3; --muted:#9aa4b2;
    }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif}
    .stage{position:relative;width:100vw;height:100vh;background:#000}

    /* Dynamic background */
    .bg{position:absolute;inset:0;overflow:hidden;filter:saturate(1.25) contrast(1.1)}
    .bg .layer{position:absolute;inset:-10%;background:conic-gradient(from 90deg at 30% 50%, #6ee7b7, #fde047, #60a5fa, #f472b6, #6ee7b7);animation:spin 30s linear infinite}
    .grain{position:absolute;inset:0;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="n"><feTurbulence baseFrequency="0.8" numOctaves="2"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity=".04"/></svg>');mix-blend-mode:overlay}
    @keyframes spin{0%{transform:scale(1.2) rotate(0)}100%{transform:scale(1.2) rotate(360deg)}}

    /* Topbar */
    .topbar{position:absolute;left:0;right:0;top:0;height:72px;display:flex;align-items:center;justify-content:center;padding:12px 24px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));z-index:5}
    .pill{background:var(--yellow);color:#222;padding:10px 18px;border-radius:14px;font-weight:900;font-size:20px}

    /* Chat panel */
    .panel{position:absolute;top:calc(50% - 300px);left:0;right:0;display:flex;justify-content:center;align-items:flex-start;z-index:6}
    .chat{position:relative;width:min(760px,88vw);height:400px;max-height:400px;background:var(--panel);backdrop-filter:blur(12px);border-radius:24px;border:1px solid rgba(255,255,255,.08);padding:22px;display:flex;flex-direction:column}
    .messages{flex:1;overflow:hidden;position:relative}
    .stream{position:absolute;left:0;right:0;top:0;display:flex;flex-direction:column;gap:12px}
    .bubble{max-width:85%;padding:18px 20px;border-radius:20px;font-size:22px;line-height:1.42;color:#0b0f14;box-shadow:0 6px 26px rgba(0,0,0,.22)}
    .bubble.other{align-self:flex-start;background:#fff}
    .bubble.you{align-self:flex-end;background:var(--cyan);color:#0b0f14}
    .bubble.system{align-self:center;background:var(--red);color:#fff;font-weight:900}
    .bubble.media{padding:12px;background:#fff}
    .bubble img{width:380px;height:auto;border-radius:16px;display:block}
    .timestamp{font-size:14px;color:#444;margin-top:6px}

    .karaoke{position:absolute;left:0;right:0;bottom:6px;text-align:center;color:#e6edf3;background:rgba(0,0,0,.35);padding:4px 8px;border-radius:8px;margin:0 auto;width:fit-content;opacity:0;transition:opacity .2s}

    /* Footer */
  </style>
</head>
<body>
  <div class="stage">
    <div class="bg" id="bg">
      <div class="layer" id="bgLayer"></div>
      <div class="grain"></div>
    </div>

    <div class="topbar">
      <div class="pill" id="ep">Ep. 1/7</div>
    </div>

    <div class="panel">
      <div class="chat">
        <div class="messages">
          <div class="stream" id="stream"></div>
          <div class="karaoke" id="karaoke">Detalhes importam.</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const ctx = {
      started:false,
      t:0,
      lastIdx:-1,
    };

    function buildChapters(total){
      const wrap = document.getElementById('chapters');
      wrap.innerHTML='';
      for(let i=0;i<total;i++){
        const d=document.createElement('div');
        d.className='dot';
        wrap.appendChild(d);
      }
    }

    function pulseEpisode(){
      const el = document.getElementById('ep');
      el.animate([{transform:'scale(1)'},{transform:'scale(1.04)'},{transform:'scale(1)'}],{duration:600});
    }

    function addBubble(msg){
      const s = document.getElementById('stream');
      const b = document.createElement('div');
      let cls='bubble';
      if(msg.type==='text') cls+=' '+(msg.who==='you'?'you':'other');
      if(msg.type==='system') cls+=' system';
      if(msg.type==='media') cls+=' media';
      if(msg.type==='alert') cls+=' system';
      b.className=cls;

      if(msg.type==='media'){
        const img=document.createElement('img');
        img.src= msg.image || 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 240"><rect width="100%" height="100%" fill="black"/><text x="50%" y="50%" fill="white" font-size="22" font-family="Arial" text-anchor="middle">ULTRASSOM</text></svg>`);
        b.appendChild(img);
        const ts=document.createElement('div'); ts.className='timestamp'; ts.textContent='10:23'; b.appendChild(ts);
      } else {
        b.textContent = msg.text;
      }

      s.appendChild(b);
      // pop animation
      b.animate([{opacity:0, transform:'translateY(6px) scale(.98)'},{opacity:1, transform:'translateY(0) scale(1)'}],{duration:160, easing:'ease-out'});

      // autoscroll
      const panelHeight = document.querySelector('.messages').clientHeight;
      const totalHeight = s.scrollHeight;
      const offset = Math.min(0, panelHeight - totalHeight - 8);
      s.style.transform = `translateY(${offset}px)`; // autoscroll up when overflow

      // karaoke short label
      const k=document.getElementById('karaoke');
      if(msg.type==='system'){
        k.textContent = msg.text;
        k.style.opacity = 1;
        setTimeout(()=>k.style.opacity=0, 1800);
      }

      // reactions on reveal
      if(msg.type==='media' || msg.type==='alert'){
        const bg = document.getElementById('bg');
        bg.animate([{filter:'saturate(1.25) contrast(1.1) blur(0px)'},{filter:'saturate(.9) contrast(1.0) blur(3px)'},{filter:'saturate(1.25) contrast(1.1) blur(0px)'}],{duration:600,easing:'ease'});
        document.querySelector('.chat').animate([{transform:'scale(1)'},{transform:'scale(1.03)'},{transform:'scale(1)'}],{duration:420});
      }

      // icon support
      if(msg.icon){
        const ico = document.createElement('div');
        ico.textContent = msg.icon;
        ico.style.fontSize = '42px';
        ico.style.lineHeight = '1';
        ico.style.marginBottom = '6px';
        if(msg.type==='text' && msg.who!=='you') b.prepend(ico);
      }
    }

    function setTimelineTime(t){
      ctx.t = t;
      const data = window.__VIDEO_DATA__ || {durationSec:90,fps:30,messages:[]};
      if(!ctx.started) return;

      const { durationSec, messages } = data;
      const ratio = Math.min(1, t / durationSec);
      if(ratio>0.85 && Math.floor(t*2)%4===0){
        pulseEpisode();
      }

      // message schedule every ~1.8s
      const interval = Math.max(1.3, Math.min(2.1, durationSec / Math.max(1, messages.length+1)));
      const idx = Math.floor(t / interval); // show next when entering slot
      if(idx !== ctx.lastIdx && idx >= 0 && idx < messages.length){
        ctx.lastIdx = idx;
        const msg = messages[idx];
        addBubble(msg);
              if(idx===0){ // hook
        document.getElementById('bgLayer').animate([{transform:'scale(1.2)'},{transform:'scale(1.26)'},{transform:'scale(1.2)'}],{duration:700,easing:'ease-out'});
      }
      // safeguard autoscroll update after layout
      setTimeout(()=>{
        const s = document.getElementById('stream');
        const panelHeight = document.querySelector('.messages').clientHeight;
        const totalHeight = s.scrollHeight;
        const offset = Math.min(0, panelHeight - totalHeight - 8);
        s.style.transform = `translateY(${offset}px)`;
      }, 50);
        if(idx===messages.length-1){
          // final hold
          setTimeout(()=>{}, 1500);
        }
      }
    }

    function startRender(){
      const data = window.__VIDEO_DATA__;
      document.getElementById('ep').textContent = `Ep. ${data.episode||1}/${data.totalEpisodes||7}`;
      ctx.started=true;
    }

    window.startRender = startRender;
    window.setTimelineTime = setTimelineTime;
  </script>
</body>
</html>